#!/bin/sh

# Print every Command being executed
#set -x

# Netcat Debugging
NC_BIN="/usr/bin/nc"
NC_HOST="192.168.3.66"
NC_PORT="12345"
NC_OPTIONS="-N -n -v ${NC_HOST} ${NC_PORT}"

# Define "losetup" Executable Path
LOSETUP_BIN="/usr/sbin/losetup-full"                                                  # Production (IMPORTANT: on the Real System it is /usr/sbin/losetup, in the initramfs it is /usr/bin/losetup !!!) - "losetup" also works correctly though
#LOSETUP_BIN="/usr/src/initramfs-investigation/6.8.0-40-generic/main/usr/bin/losetup" # Testing with uncompressed initramfs

# Define "losetup" Command-Line Options
LOSETUP_OPTIONS="-b 4096"

# Timestamp
TIMESTAMP=`date +"%Y%m%d-%H%M%S"`

# Echo
echo "Starting DEBUG at $TIMESTAMP"  | ${NC_BIN} ${NC_OPTIONS}

# Check if Command Exists
# If not, default to "losetup"
if [ ! -x "${LOSETUP_BIN}" ]
then
    # Echo
    echo "WARNING: the specified losetup Binary ${LOSETUP_BIN} could NOT be found and/or is NOT executable." | ${NC_BIN} ${NC_OPTIONS}

    if [ -x "/usr/bin/losetup" ]
    then
       LOSETUP_BIN="/usr/bin/losetup"
    elif [ -x "/usr/sbin/losetup" ]
    then
       LOSETUP_BIN="/usr/sbin/losetup"
    else
       # Echo
       echo "WARNING: losetup Binary couldn't be automatically Detected. Defaulting to <losetup>" | ${NC_BIN} ${NC_OPTIONS}

       # Default Value
       LOSETUP_BIN="losetup"
    fi
fi

# Echo
echo "INFO: Using losetup Executable / Command: ${LOSETUP_BIN}" | ${NC_BIN} ${NC_OPTIONS}

# List /dev/mapper/ Devices
echo "List of /dev/mapper/ Devices" | ${NC_BIN} ${NC_OPTIONS}
ls -l /dev/mapper/* | ${NC_BIN} ${NC_OPTIONS}

# List /dev/loop/ Devices
echo "List of /dev/loop/ Devices" | ${NC_BIN} ${NC_OPTIONS}
ls -l /dev/loop/* | ${NC_BIN} ${NC_OPTIONS}

# Get Output of zpool status -v
echo "Get zpool status Output" | ${NC_BIN} ${NC_OPTIONS}
zpool status -v | ${NC_BIN} ${NC_OPTIONS}

# Get Outout of zpool get path rpool all-vdevs
echo "Get zpool get path rpool all-vdevs Output" | ${NC_BIN} ${NC_OPTIONS}
zpool get path rpool all-vdevs | ${NC_BIN} ${NC_OPTIONS}

# Iterate over each Device
echo "Analysing Loop Device Details" | ${NC_BIN} ${NC_OPTIONS}
cat /etc/looptab | grep -vE "^#" | while IFS= read -r line;
do
    # Extract "ID"
    loopDeviceNumber=`echo "$line" | cut -f1 -d'	'`

    # Extract "Source" Device
    sourceDevice=`echo "$line" | cut -f2 -d'	'`

    # Extract "Loop" Device with Custom Name
    loopDeviceCustomName=`echo "$line" | cut -f3 -d'	'`

    # Build "Standardized" Device Path
    loopDevicePath="/dev/loop$loopDeviceNumber"

    # Check if Device Exists
    if [ -b $loopDevicePath ]
    then
        # Echo
        echo "Check Loop Device Information for $loopDevicePath"| ${NC_BIN} ${NC_OPTIONS}
        echo "Executing Command: ${LOSETUP_BIN} $loopDevicePath" | ${NC_BIN} ${NC_OPTIONS}

        # Run Command
        losetup --verbose $loopDevicePath --list --output NAME,SIZELIMIT,OFFSET,AUTOCLEAR,RO,BACK-FILE,DIO,LOG-SEC,BACK-INO,BACK-MAJ:MIN,MAJ:MIN,PARTSCAN | ${NC_BIN} ${NC_OPTIONS}
    fi
done

# Get dmsetup table Output
echo "Analysing dmsetup Table Ouput" | ${NC_BIN} ${NC_OPTIONS}
dmsetup table | ${NC_BIN} ${NC_OPTIONS}

# Get lsblk Output
echo "Analysing lsblk Ouput" | ${NC_BIN} ${NC_OPTIONS}
lsblk --all --bytes -to +START,SIZE,TYPE --output NAME,ALIGNMENT,MIN-IO,OPT-IO,PHY-SEC,LOG-SEC,ROTA,SCHED,RQ-SIZE,RA,WSAME,START,SIZE,TYPE,MAJ:MIN | ${NC_BIN} ${NC_OPTIONS}

# Send Contents of /run/initramfs/initramfs.debug to Remote Netcat Server
if [ -f "/run/initramfs/initramfs.debug" ]
then
   cat "/run/initramfs/initramfs.debug" | ${NC_BIN} ${NC_OPTIONS}
fi

# Copy /run/initramfs/initramfs.debug to /var/log/initramfs.debug.$timestamp
if [ -f "/run/initramfs/initramfs.debug" ]
then
   cp "/run/initramfs/initramfs.debug" "/var/log/initramfs.debug.$TIMESTAMP"
fi

# Force zpool reopen
zpool reopen
zpool reopen rpool

# Echo
echo "Ending DEBUG at $TIMESTAMP"  | ${NC_BIN} ${NC_OPTIONS}

# Return OK Code
exit 0
